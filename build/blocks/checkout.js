(()=>{"use strict";const e=window.React,t=(window.wp.i18n,window.wp.plugins),n=window.wp.data,o=window.wp.element,i=window.wp.hooks,c=window.ReactDOM,r=()=>{const t=(e,t,n=null)=>{if(!(()=>{const e=new URLSearchParams(window.location.search);return"1"===e.get("econt_debug")||"true"===e.get("econt_debug")})())return;const o=`[ECONT-${e}] ${(new Date).toISOString().split("T")[1].split(".")[0]}:`;n?(console.group(o,t),console.log("Data:",n),console.groupEnd()):console.log(o,t)},r=(0,o.useRef)(Math.random().toString(36).substr(2,9));t("INIT",`EcontDelivery component initializing - Instance: ${r.current}`);const a=window.jQuery,s=window.wp,l=e=>void 0!==window.econtTranslations&&window.econtTranslations[e]?window.econtTranslations[e]:e,[d,p]=(0,o.useState)(""),[u,m]=(0,o.useState)({cod:void 0,cod_e:void 0,no_cod:void 0}),[g,h]=(0,o.useState)(!0),[f,y]=(0,o.useState)(null),[_,v]=(0,o.useState)(!1),[w,b]=(0,o.useState)(null),[E,S]=(0,o.useState)(!1),[k,A]=(0,o.useState)(!0),D=(0,o.useRef)(!0),T=(0,o.useRef)(null),$=(0,o.useRef)(null),R=(0,o.useRef)(!1),F=(0,o.useRef)(null),{billingData:I,shippingData:x,cartData:C,selectedShippingMethod:M}=(0,n.useSelect)(e=>{t("STORE",`useSelect hook called - Instance: ${r.current}`);const n=e("wc/store/cart");if(!n)return{billingData:{},shippingData:{},cartData:{},selectedShippingMethod:null};let o={},i={},c={},a=null;try{o=n.getCustomerData()?.billing||{},i=n.getCustomerData()?.shipping||{};const e=n.getCartData(),t=.001*e.itemsWeight,r=t>0?t:1;c={total:Number.parseFloat(e.totals?.total_items)/100||0,currency:n.getCartTotals()?.currency_code||"BGN",weight:r};const s=n.getShippingRates();a=s?.[0]?.shipping_rates?.find(e=>e.selected)?.method_id}catch(e){try{o=n.getBillingData()||{},i=n.getShippingData()||{}}catch(e){}}return{billingData:o,shippingData:i,cartData:c,selectedShippingMethod:a}},[]),{setBillingAddress:q,setShippingAddress:N}=(0,n.useDispatch)("wc/store/cart"),O=()=>{if(f&&f.includes("econt"))return t("CHECK","Econt found in local shipping method",f),!0;if(M&&("delivery_with_econt"===M||M.includes("econt")))return t("CHECK","Econt found in selected shipping method",M),!0;const e=document.querySelector('input[name^="shipping_method"][value*="econt"]:checked');return e?(t("CHECK","Econt radio button found checked in DOM",e.value),!0):!!(d&&d.length>0)&&(t("CHECK","Econt detected via iframe URL",d),!0)},P=()=>{if(!D.current)return null;const e=(()=>{const e=["#shipping-option",".wc-block-components-shipping-rates-control",".shipping_method",".woocommerce-shipping-methods","#shipping_method"];for(const n of e){const e=document.querySelector(n);if(e)return t("DOM",`Found shipping container with selector: ${n}`),e}return t("DOM","No shipping container found"),null})();if(!e)return null;let n=document.getElementById("econt-portal-container");return n?t("PORTAL","Using existing portal container"):(t("PORTAL","Creating new portal container"),n=document.createElement("div"),n.id="econt-portal-container",e.nextSibling?e.parentNode.insertBefore(n,e.nextSibling):e.parentNode.appendChild(n)),n},B=e=>{t("BUTTON",`Toggling place order button - disable: ${e}`);const n=document.querySelector(".wc-block-components-checkout-place-order-button");n&&(n.disabled=e,e?(n.style.opacity="0.5",n.style.cursor="not-allowed",n.title=l("Please complete Econt delivery details first")):(n.style.opacity="",n.style.cursor="",n.title=""),S(e))},L=async()=>{if(t("FORM",`Getting data from form - Instance: ${r.current}`),!D.current||!O())return void t("FORM","Component not mounted or Econt not selected, skipping");if(R.current)return void t("FORM","AJAX request already in progress, skipping");await new Promise(e=>setTimeout(e,100));const e={first_name:document.querySelector("#shipping-first_name")?.value||document.querySelector("#billing-first_name")?.value||"",last_name:document.querySelector("#shipping-last_name")?.value||document.querySelector("#billing-last_name")?.value||"",company:document.querySelector("#shipping-company")?.value||document.querySelector("#billing-company")?.value||"",address_1:document.querySelector("#shipping-address_1")?.value||document.querySelector("#billing-address_1")?.value||"",city:document.querySelector("#shipping-city")?.value||document.querySelector("#billing-city")?.value||"",postcode:document.querySelector("#shipping-postcode")?.value||document.querySelector("#billing-postcode")?.value||"",phone:document.querySelector("#shipping-phone")?.value||document.querySelector("#billing-phone")?.value||"",email:document.querySelector("#email")?.value||document.querySelector("#shipping-email")?.value||document.querySelector("#billing-email")?.value||""};if(t("FORM","Customer data extracted",e),!e.first_name||!e.city)return t("FORM","Insufficient customer data, retrying in 1 second"),void(D.current&&setTimeout(L,1e3));let n=!1,o="",i="";e.address_1&&(e.address_1.includes("Delivery to office:")?(n=!0,o=e.address_1.replace("Delivery to office:","").trim()):i=e.address_1.includes("Delivery to address:")?e.address_1.replace("Delivery to address:","").trim():e.address_1);const c={customer_name:`${e.first_name} ${e.last_name}`.trim(),customer_company:e.company,customer_address:i,customer_city_name:e.city,customer_post_code:e.postcode,customer_phone:e.phone,customer_email:e.email,office_name:n?o:""};Object.keys(c).forEach(e=>{c[e]||delete c[e]});const s={...c,order_total:C.total||0,order_currency:C.currency||"BGN",pack_count:1,order_weight:C.weight},l=JSON.stringify(s);if(F.current!==l){F.current=l,R.current=!0;try{if(t("AJAX","Making AJAX request",s),void 0!==a){A(!0);const e=await a.ajax({type:"POST",url:window.econtData.ajaxUrl,dataType:"json",data:{action:"woocommerce_delivery_with_econt_get_orderinfo",security:window.econtData.nonce,params:s}});if(t("AJAX","AJAX response received",e),!e)return void t("AJAX","No response received");let n;if("string"==typeof e)n=e.split('"').join("").replace(/\\\//g,"/");else{if("object"!=typeof e)return void t("AJAX","Invalid response type");n=e.toString()}const o=document.documentElement.lang.split("-")[0]||"en",i=`${n}&module=onecheckout&lang=${["bg","en","gr","ro"].includes(o)?o:"bg"}`;t("AJAX","Final URL constructed",i),i!==d?U(i,!0):(t("IFRAME","URL unchanged, skipping iframe update"),A(!1))}}catch(e){t("AJAX","AJAX request failed",e),A(!1)}finally{R.current=!1}}else t("FORM","Same form data as last request, skipping AJAX")},U=(e,n=!0)=>{t("IFRAME",`Updating iframe with URL: ${e}, visible: ${n}`),D.current&&(p(e),A(!0),setTimeout(()=>{if(!D.current)return;const o=document.querySelector("#delivery_with_econt_iframe");if(o)t("IFRAME","Iframe element found, setting src"),o.src=e,n&&(o.style.display="block",o.style.visibility="visible",o.style.height="500px"),o.onload=()=>{t("IFRAME","Iframe loaded successfully");try{o.contentDocument||o.contentWindow,D.current&&A(!1)}catch(e){t("IFRAME","Cross-origin iframe loaded (expected)",e.message),D.current&&A(!1)}},o.onerror=()=>{t("IFRAME","Iframe failed to load"),D.current&&A(!1)};else if(D.current){t("IFRAME","Iframe element not found, creating portal container and retrying");const o=P();o&&b(o),setTimeout(()=>{D.current&&U(e,n)},500)}},100))},G=async e=>{try{const t=s.data.select("wc/store/cart"),n=s.data.dispatch("wc/store/cart");t&&n?(await n.setBillingAddress(e),await n.setShippingAddress(e),await new Promise(e=>setTimeout(e,300))):j(e)}catch(n){t("MESSAGE","WooCommerce store update failed, falling back to direct field updates",n),j(e)}},j=e=>{if(console.log("updateFieldsDirectly"),console.log(void 0!==a),void 0!==a){const n=["first_name","last_name","company","address_1","city","postcode","phone","email"];console.log("123"),n.forEach(n=>{console.log("foreach");const o=e[n]||"";let i=!1;[`#shipping-${n}`,`#billing-${n}`,`input[name="shipping_${n}"]`,`input[name="billing_${n}"]`,`input[name="${n}"]`,`[data-field="${n}"]`,`.wc-block-components-text-input[name*="${n}"]`,`input[id*="${n}"]`].forEach(e=>{console.log("selectors foreach");const n=a(e);if(n.length>0){const c=n.val();n.val(o),n.trigger("input").trigger("change").trigger("blur"),console.log(n.val());const r=n[0];if(r){const e=new Event("input",{bubbles:!0}),t=new Event("change",{bubbles:!0});r.dispatchEvent(e),r.dispatchEvent(t)}o!==c&&(i=!0,t("UPDATE",`Updated ${e}: "${c}" -> "${o}"`))}}),!i&&o&&t("UPDATE",`Warning: Could not update field ${n} with value "${o}"`)}),a(document.body).trigger("update_checkout")}},J=async e=>{const n=e.data;if(!n.shipment_error&&null!=n.shipping_price&&!isNaN(Number(n.shipping_price))&&n.name){t("MESSAGE","Processing valid shipment data",n);try{if(document.cookie=`econt_shippment_price=${n.shipping_price}; path=/`,document.cookie=`econt_customer_info_id=${n.id}; path=/`,void 0!==a){const e=await a.ajax({type:"POST",url:window.econtData.ajaxUrl,dataType:"json",data:{action:"woocommerce_delivery_with_econt_update_shipping",security:window.econtData.nonce,shipping_data:{price:n.shipping_price,price_cod:n.shipping_price_cod,price_cod_e:n.shipping_price_cod_e,currency:n.shipping_price_currency_sign}}});if(!e.success)throw new Error(e.message||"Failed to update shipping rate");m({cod:n.shipping_price_cod,cod_e:n.shipping_price_cod_e,no_cod:n.shipping_price}),s.data.dispatch("wc/store/cart").invalidateResolutionForStoreSelector("getCartData"),h(!1),B(!0),await new Promise(e=>setTimeout(e,1e3));const o={first_name:n.face?n.face.split(" ")[0]:n.name.split(" ")[0],last_name:n.face?n.face.split(" ")[1]:n.name.split(" ")[1],company:n.face?n.name:"",address_1:n.address?`${l("Delivery to address:")} ${n.address}`:`${l("Delivery to office:")} ${n.office_name_only}`,city:n.city_name,postcode:n.post_code,phone:n.phone,email:n.email};for(let e=0;e<2;e++)t("MESSAGE",`Address update attempt ${e+1}/2`),await G(o),await X(o)?(await new Promise(e=>setTimeout(e,500)),B(!1),t("MESSAGE","All fields updated successfully, submit button enabled")):(t("MESSAGE","Field update verification failed, keeping button disabled"),B(!0));h(!1),A(!1)}}catch(e){t("MESSAGE","Error processing message",e),h(!1),A(!1),B(!0)}}},X=async e=>{if(void 0===a)return!1;const n=["first_name","last_name","company","address_1","city","postcode","phone","email"];let o=!0;for(let i=0;i<3;i++){o=!0;for(const i of n){const n=a(`#shipping-${i}`),c=a(`#billing-${i}`),r=n.length?n.val():null,s=c.length?c.val():null,l=e[i]||"";if((n.length||c.length)&&r!==l&&s!==l){t("MESSAGE",`Field ${i} not updated. Expected: ${l}, Got shipping: ${r}, billing: ${s}`),o=!1;break}}if(o)return t("MESSAGE","All fields verified as updated"),!0;await new Promise(e=>setTimeout(e,200))}return t("MESSAGE","Field verification failed after 3 attempts"),!1};(0,o.useEffect)(()=>{t("EFFECT",`Shipping method check effect triggered - Instance: ${r.current}`);const e=()=>{const e=O();if(v(e),M&&M!==f&&(t("EFFECT","Updating local shipping method",{old:f,new:M}),y(M)),e){t("EFFECT","Econt is selected, setting up portal and getting form data");const e=P();e&&b(e),d||(h(!0),B(!0)),L()}else t("EFFECT","Econt not selected, enabling place order button"),B(!1),A(!1)};e();const n=()=>{t("EVENT","Shipping method change event triggered"),e()};return void 0!==a&&(t("EVENT","Adding jQuery event listeners"),a(document.body).on("updated_checkout",n),a('input[name^="shipping_method"]').on("change",n)),()=>{t("EVENT","Cleaning up shipping method event listeners"),void 0!==a&&(a(document.body).off("updated_checkout",n),a('input[name^="shipping_method"]').off("change",n))}},[M,f,I,x,C,d]),(0,o.useEffect)(()=>{if(_){const e=P();e&&b(e),g&&!u.no_cod&&B(!0)}else B(!1)},[_,g,u]),(0,o.useEffect)(()=>(t("EFFECT",`Setting up message event listener - Instance: ${r.current}`),T.current=J,window.addEventListener("message",J),()=>{t("EFFECT",`Cleaning up message event listener - Instance: ${r.current}`),window.removeEventListener("message",J),T.current=null}),[]),(0,o.useEffect)(()=>()=>{t("CLEANUP",`Component unmounting - Instance: ${r.current}`),D.current=!1,void 0!==a&&(a(document.body).off("updated_checkout"),a('input[name^="shipping_method"]').off("change")),T.current&&(window.removeEventListener("message",T.current),T.current=null);const e=document.getElementById("econt-portal-container");e&&e.remove(),B(!1)},[]),(0,o.useEffect)(()=>{const e=()=>{_&&g&&!u.no_cod?B(!0):_||B(!1)};return void 0!==a&&a(document.body).on("updated_checkout",e),()=>{void 0!==a&&a(document.body).off("updated_checkout",e)}},[_,g,u]);const H=l("Econt Delivery Details"),z=l("Edit delivery details"),K=(0,i.applyFilters)("econtDelivery.editButtonText",H),W=(0,i.applyFilters)("econtDelivery.checkoutButtonText",z),V=()=>(t("RENDER",`Rendering component content - Instance: ${r.current}`,{isEcontSelected:_,isEditing:g,isIframeLoading:k,iframeUrl:d?"present":"empty"}),(0,e.createElement)("div",{className:"econt-content-wrapper",style:{display:_?"block":"none",visibility:_?"visible":"hidden"}},(0,e.createElement)("h3",null,K),(0,e.createElement)("div",{className:"econt-iframe-container",style:{display:_&&g?"block":"none",visibility:_&&g?"visible":"hidden"}},_&&g&&k&&(0,e.createElement)("div",{className:"econt-loading",style:{padding:"20px",marginBottom:"20px",backgroundColor:"#f8f9fa",border:"1px solid #ddd",borderRadius:"4px",textAlign:"center"}},(0,e.createElement)("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",marginBottom:"10px"}},(0,e.createElement)("div",{className:"econt-spinner",style:{width:"30px",height:"30px",border:"4px solid rgba(0, 0, 0, 0.1)",borderRadius:"50%",borderTop:"4px solid #3498db",animation:"econt-spin 1s linear infinite"}})),(0,e.createElement)("div",null,l("Loading Econt delivery options...")),(0,e.createElement)("style",null,"\n                                @keyframes econt-spin {\n                                    0% { transform: rotate(0deg); }\n                                    100% { transform: rotate(360deg); }\n                                }\n                                ")),(0,e.createElement)("iframe",{src:d||"about:blank",id:"delivery_with_econt_iframe",style:{marginTop:"2rem",width:"100%",minHeight:"600px",border:"none",display:_&&g&&d&&!k?"block":"none",visibility:_&&g&&d&&!k?"visible":"hidden"},onLoad:()=>{if(t("IFRAME","Iframe onLoad event triggered"),!d)return;const e=document.getElementById("delivery_with_econt_iframe");e&&_&&g&&(A(!1),e.style.display="block",e.style.visibility="visible",t("IFRAME","Iframe made visible after load"))}})),_&&!g&&(0,e.createElement)("button",{type:"button",className:"econt-button econt-button-details",style:{display:"block",visibility:"visible",marginBottom:"40px"},onClick:()=>{t("BUTTON","Edit button clicked"),h(!0),A(!0),B(!0),_&&!d&&L()}},W),_&&E&&(0,e.createElement)("div",{className:"econt-button-message",style:{marginTop:"10px",padding:"10px",backgroundColor:"#fff9c4",border:"1px solid #ffd600",borderRadius:"4px",fontSize:"14px",textAlign:"center"}},l("Please complete Econt delivery details before placing your order"))));return w&&_?(t("RENDER",`Rendering through portal - Instance: ${r.current}`),(0,c.createPortal)((0,e.createElement)("div",{ref:$,className:"wp-block-econt-delivery",style:{position:"relative",zIndex:"10",display:"block",visibility:"visible",opacity:"1",marginTop:"20px",marginBottom:"32px"},"data-econt-component":"true","data-econt-shipping-selected":"true","data-econt-iframe-url":d?"loaded":"not-loaded","data-econt-iframe-loading":k?"true":"false","data-econt-instance":r.current},V()),w)):(t("RENDER",`Rendering fallback (no portal) - Instance: ${r.current}`),(0,e.createElement)("div",{ref:$,className:"wp-block-econt-delivery",style:{position:"relative",zIndex:_?"10":"-1",display:_?"block":"none",visibility:_?"visible":"hidden",opacity:_?"1":"0"},"data-econt-component":"true","data-econt-shipping-selected":_?"true":"false","data-econt-iframe-url":d?"loaded":"not-loaded","data-econt-iframe-loading":k?"true":"false","data-econt-instance":r.current},V()))},a=()=>{const{cartData:e,shippingData:t,selectedShippingMethod:i}=(0,n.useSelect)(e=>{const t=e("wc/store/cart");if(!t)return{cartData:null,shippingData:null,selectedShippingMethod:null};const n=t.getShippingRates(),o=n?.[0]?.shipping_rates?.find(e=>e.selected);return{cartData:t.getCartData(),shippingData:n,selectedShippingMethod:o?.method_id}},[]),c=e=>void 0!==window.econtTranslations&&window.econtTranslations[e]?window.econtTranslations[e]:e,r=()=>"delivery_with_econt"===i;return(0,o.useEffect)(()=>{if(!r())return;const e=()=>{const e=(()=>{const e=`; ${document.cookie}`.split("; econt_shippment_price=");return 2===e.length?e.pop().split(";").shift():null})();if(console.log("Econt price check:",e),"0"===e){const e=document.querySelector('input[value="delivery_with_econt"]');if(e){const t=e.closest("label")?.querySelector(".wc-block-components-radio-control__secondary-label");if(t){let e=t.querySelector(".wc-block-checkout__shipping-option--free");e&&(e.textContent=c("Free"))}}const t=document.querySelector(".wc-block-components-totals-shipping .wc-block-components-totals-item__value");t&&r()&&(t.innerHTML=`<strong>${c("Free")}</strong>`)}else e&&""!==e||(e=>{const t=document.querySelector('input[value="delivery_with_econt"]');if(t){const n=t.closest("label")?.querySelector(".wc-block-components-radio-control__secondary-label");if(n){let t=n.querySelector(".wc-block-checkout__shipping-option--free");t&&(t.textContent=e)}}const n=document.querySelector(".wc-block-components-totals-shipping .wc-block-components-totals-item__value");n&&r()&&(n.innerHTML=`<strong>${e}</strong>`)})(c("Calculating..."))};e();let t=0;const n=setInterval(()=>{t++,(document.querySelector(".wc-block-components-totals-shipping .wc-block-components-totals-item__value")||t>=15)&&clearInterval(n),e()},200);return()=>clearInterval(n)},[i,e,t]),null};console.log("Registering Econt delivery block plugins");const{isPluginActive:s}=wp.plugins||{};s&&s("econt-delivery-block")||(0,t.registerPlugin)("econt-delivery-block",{render:()=>{const{isEcontShippingSelected:t}=(0,n.useSelect)(e=>{const t=e("wc/store/cart");if(!t)return{isEcontShippingSelected:!1};const n=t.getShippingRates(),o=n?.[0]?.shipping_rates?.find(e=>e.selected);return{isEcontShippingSelected:"delivery_with_econt"===o?.method_id}},[]);return t?(0,e.createElement)(r,null):null},scope:"woocommerce-checkout"}),s&&s("econt-always-loaded")||(0,t.registerPlugin)("econt-always-loaded",{render:a,scope:"woocommerce-checkout"}),s&&s("econt-cart-always-loaded")||(0,t.registerPlugin)("econt-cart-always-loaded",{render:a,scope:"woocommerce-cart"})})();